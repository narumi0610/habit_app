name: Flutter CI

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©
on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«å®Ÿè¡Œ
  pull_request:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®PRä½œæˆæ™‚ã«å®Ÿè¡Œ

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã®ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  build:
    # ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ä»®æƒ³ç’°å¢ƒã‚’æŒ‡å®š
    runs-on: ubuntu-latest

    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v2

    # Flutterã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.3'  # ä½¿ç”¨ã™ã‚‹Flutterã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

    # Flutterã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: flutter pub get

    # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§GitHub Secretsã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«ä½œæˆ
    - name: Create .env
      run: echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env

    # ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    - name: Run linter
      run: flutter analyze

    # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    - name: Run tests
      run: flutter test

    # Androidã®keystoreãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆkey.jksï¼‰ã‚’Secretsã‹ã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦é…ç½®
    - name: Decode keystore
      run: echo "${{ secrets.SIGNING_KEY }}" | base64 -d > android/app/key.jks

    # Androidã®ãƒ“ãƒ«ãƒ‰ï¼ˆSecretsã‹ã‚‰ç½²åæƒ…å ±ã‚’å–å¾—ï¼‰
    - name: Build APK (Android)
      run: flutter build apk --release
      env:
        KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        ALIAS: ${{ secrets.ALIAS }}
        KEY_PATH: android/app/key.jks

    # ãƒ“ãƒ«ãƒ‰ã—ãŸapkã‚’github Actionsã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: "Deploy apk ğŸš€"
      uses: actions/upload-artifact@v2
      with:
        name: release-apk  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®åå‰
        path: build/app/outputs/flutter-apk/app-release.apk

    # iOSã®ãƒ“ãƒ«ãƒ‰
    - name: Build iOS
      run: flutter build ios --release
